!function(t){var i={calculateColor:function(t,i){if(0===t.indexOf("#")){var s=t.slice(1);return"rgba("+parseInt(s.slice(0,2),16)+","+parseInt(s.slice(2,4),16)+","+parseInt(s.slice(4),16)+","+i+")"}return/^rgb\(/.test(t)?t.replace(/rgb/,"rgba").replace(")",",")+i+")":t.split(",").splice(0,3).join(",")+i+")"}},s={forEach:function(t,i,s){if("function"==typeof Array.prototype.forEach)t.forEach(i,s);else for(var a=0,e=t.length;a<e;a++)i.apply(s,[t[a],a,t])},map:function(t,i,s){if("function"==typeof Array.prototype.map)return t.map(i,s);for(var a=[],e=0,r=t.length;e<r;e++)a[e]=i.apply(s,[t[e],e,t]);return a}},a=function(){var t=function(t){this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.style=t.style,this.color=t.color,this.size=t.size,this.borderWidth=t.borderWidth,this.borderColor=t.borderColor};return t.prototype.draw=function(t){t.save(),t.translate(this.x,this.y),t.rotate(this.rotation),t.lineWidth=this.borderWidth||0,t.strokeStyle=this.borderColor||"#000",t.fillStyle=this.color||"#000",t.beginPath(),"circle"===this.style?t.arc(0,0,this.size,0,2*Math.PI,!1):"arrow"===this.style&&(t.moveTo(2*-this.size,-this.size),t.lineTo(5*-this.size/4,0),t.lineTo(2*-this.size,this.size),t.lineTo(0,0),t.lineTo(2*-this.size,-this.size)),t.closePath(),t.stroke(),t.fill(),t.restore()},t}(),e=function(){var t=function(t){var i=t.startX,s=t.startY,a=t.endX,e=t.endY,r=Math.sqrt(Math.pow(i-a,2)+Math.pow(s-e,2)),o=1.5*(s-e)+(i+a)/2,n=1.5*(a-i)+(s+e)/2,h=Math.sqrt(Math.pow(r/2,2)+Math.pow(1.5*r,2)),l=Math.atan2(s-n,i-o),d=Math.atan2(e-n,a-o);this.startX=i,this.startY=s,this.endX=a,this.endY=e,this.centerX=o,this.centerY=n,this.startAngle=l,this.endAngle=d,this.startLabel=t&&t.labels&&t.labels[0],this.endLabel=t&&t.labels&&t.labels[1],this.radius=h,this.lineWidth=t.width||1,this.strokeStyle=t.color||"#000",this.label=t.label,this.font=t.font,this.shadowBlur=t.shadowBlur,this.endAngle=d-this.lineWidth/h};return t.prototype.draw=function(t){if(t.save(),t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeStyle,t.shadowColor=this.strokeStyle,t.shadowBlur=this.shadowBlur||2,t.beginPath(),t.arc(this.centerX,this.centerY,this.radius,this.startAngle,this.endAngle,!1),t.stroke(),t.restore(),t.save(),t.fillStyle=this.strokeStyle,this.label){if(t.font=this.font,this.startLabel){var i=this.startX-15,s=this.startY+5;t.fillText(this.startLabel,i,s)}if(this.endLabel){var i=this.endX-15,s=this.endY-5;t.fillText(this.endLabel,i,s)}}t.restore()},t}(),r=function(){function t(t){this.x=t.x,this.y=t.y,this.maxRadius=t.radius,this.color=t.color,this.shadowBlur=5,this.lineWidth=t.borderWidth,this.r=0,this.factor=2/t.radius}return t.prototype.draw=function(t){this.r+=.5,t.save(),t.translate(this.x,this.y);var s=this.color;s=i.calculateColor(s,1-this.r/this.maxRadius),t.strokeStyle=s,t.shadowBlur=this.shadowBlur,t.shadowColor=s,t.lineWidth=this.lineWidth,t.beginPath(),t.arc(0,0,this.r,0,2*Math.PI,!1),t.stroke(),t.restore(),Math.abs(this.maxRadius-this.r)<.8&&(this.r=0)},t}(),o=function(){var t=function(t){var i=t.startX,s=t.startY,e=t.endX,r=t.endY,o=Math.sqrt(Math.pow(i-e,2)+Math.pow(s-r,2)),n=1.5*(s-r)+(i+e)/2,h=1.5*(e-i)+(s+r)/2,l=Math.sqrt(Math.pow(o/2,2)+Math.pow(1.5*o,2)),d=Math.atan2(s-h,i-n),c=Math.atan2(r-h,e-n);d*c<0&&(d<0?(d+=2*Math.PI,c+=2*Math.PI):c+=2*Math.PI),this.tailPointsCount=50,this.centerX=n,this.centerY=h,this.startAngle=d,this.endAngle=c,this.radius=l,this.lineWidth=t.width||1,this.strokeStyle=t.color||"#fff",this.factor=2/this.radius,this.deltaAngle=80/Math.min(this.radius,400)/this.tailPointsCount,this.trailAngle=this.startAngle,this.arcAngle=this.startAngle,this.animateBlur=!0;const p=t.size?t.size/2:1;this.marker=new a({x:50,y:80,rotation:50*Math.PI/180,style:"arrow",color:"rgb(255, 255, 255)",size:p+1,borderWidth:p,borderColor:this.strokeStyle})};return t.prototype.drawArc=function(t,i,s,a,e){t.save(),t.lineWidth=s,t.strokeStyle=i,t.shadowColor=this.strokeStyle,t.lineCap="round",t.beginPath(),t.arc(this.centerX,this.centerY,this.radius,a,e,!1),t.stroke(),t.restore()},t.prototype.draw=function(t){var s=this.endAngle,a=this.trailAngle+this.factor,e=this.strokeStyle;this.animateBlur&&(this.arcAngle=a),this.trailAngle=a,e=i.calculateColor(e,.1),this.drawArc(t,e,this.lineWidth,this.startAngle,this.arcAngle);for(var r=this.tailPointsCount,o=0;o<r;o++){var n=i.calculateColor(this.strokeStyle,.3-.3/r*o);this.trailAngle-this.deltaAngle*o>this.startAngle&&this.drawArc(t,n,5-5/r*o,this.trailAngle-this.deltaAngle*o,this.trailAngle)}t.save(),t.translate(this.centerX,this.centerY),this.marker.x=Math.cos(this.trailAngle)*this.radius,this.marker.y=Math.sin(this.trailAngle)*this.radius,this.marker.rotation=this.trailAngle+Math.PI/2,this.marker.draw(t),t.restore(),180*(s-this.trailAngle)/Math.PI<.5&&(this.trailAngle=this.startAngle,this.animateBlur=!1)},t}(),n=function(){var i=function(t){this.data=t.data,this.store={arcs:[],markers:[],pulses:[],sparks:[]},this.playAnimation=!0,this.started=!1,this.context=t.context,this.style=t.style,this.init()};return i.prototype.init=function(){this.updateData(this.data)},i.prototype.add=function(t){},i.prototype.remove=function(){},i.prototype.clear=function(){this.store={arcs:[],markers:[],pulses:[],sparks:[]},this.playAnimation=!0,this.started=!1,t.cancelAnimationFrame(this.requestAnimationId)},i.prototype.updateData=function(t){t&&0!==t.length&&(this.clear(),this.data=t,this.data&&this.data.length>0&&s.forEach(this.data,function(t){var i=new e({startX:t.from[0],startY:t.from[1],endX:t.to[0],endY:t.to[1],labels:t.labels,label:this.style.arc.label,font:this.style.arc.font,width:t.arcWidth||this.style.arc.width,color:t.color}),s=new a({x:t.to[0],y:t.to[1],rotation:i.endAngle+Math.PI/2,style:"arrow",color:t.color,size:t.arcWidth||this.style.arc.width+3,borderWidth:0,borderColor:t.color}),n=new r({x:t.to[0],y:t.to[1],radius:this.style.pulse.radius,color:t.color,borderWidth:this.style.pulse.borderWidth}),h=new o({startX:t.from[0],startY:t.from[1],endX:t.to[0],endY:t.to[1],width:15,color:t.color,size:t.arcWidth});this.store.arcs.push(i),this.store.markers.push(s),this.store.pulses.push(n),this.store.sparks.push(h)},this))},i.prototype.start=function(i){var s=this;this.started||(!function a(){if(s.requestAnimationId=t.requestAnimationFrame(a,i),s.playAnimation){i.width+=1,i.width-=1;for(var e in s.store)for(var r=s.store[e],o=0,n=r.length;o<n;o++)r[o].draw(s.context)}}(),this.started=!0)},i.prototype.play=function(){this.playAnimation=!0},i.prototype.pause=function(){this.playAnimation=!1},i}();L.MigrationLayer=L.Class.extend({options:{map:{},data:{},pulseRadius:25,pulseBorderWidth:3,arcWidth:1,arcLabel:!0,arcLabelFont:"15px sans-serif",Marker:{},Spark:{}},_setOptions:function(t,i){t.hasOwnProperty("options")||(t.options=t.options?L.Util.create(t.options):{});for(var s in i)t.options[s]=i[s];return t.options},initialize:function(t){this._setOptions(this,t),this._map=this.options.map||{},this._data=this.options.data||{},this._style={pulse:{radius:this.options.pulseRadius,borderWidth:this.options.pulseBorderWidth},arc:{width:this.options.arcWidth,label:this.options.arcLabel,font:this.options.arcLabelFont}}||{},this._show=!0,this._init()},_init:function(){var t=L.DomUtil.create("div","leaflet-ODLayer-container");if(t.style.position="absolute",t.style.width=this._map.getSize().x+"px",t.style.height=this._map.getSize().y+"px",this.container=t,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),t.appendChild(this.canvas),!this.migration){var i=this._convertData();this.migration=new n({data:i,context:this.context,style:this._style})}},_resize:function(){var i=this._map.getBounds().getNorthWest(),s=this._map.latLngToContainerPoint(i);s.y>0?this.container.style.top=-s.y+"px":this.container.style.top="0px";var a=t.getComputedStyle(this._map.getContainer());this.canvas.setAttribute("width",parseInt(a.width,10)),this.canvas.setAttribute("height",parseInt(a.height,10))},_convertData:function(){var t=this._map.getBounds();let i,a;if(this._data&&t){s.forEach(this._data,function(t){t.value&&(i||(i=t.value,a=t.value),i<t.value&&(i=t.value),a>t.value&&(a=t.value))});var e=this.options.maxWidth||10;return s.map(this._data,function(t){t.value&&(i||(i=t.value,a=t.value),i<t.value&&(i=t.value),a>t.value&&(a=t.value));var s=this._map.latLngToContainerPoint(new L.LatLng(t.from[1],t.from[0])),r=this._map.latLngToContainerPoint(new L.LatLng(t.to[1],t.to[0]));return{from:[s.x,s.y],to:[r.x,r.y],labels:t.labels,value:t.value,color:t.color,arcWidth:t.value?parseInt((t.value-a)*(e-1)/(i-a))+1:this.options.arcWidth}},this)}},_bindMapEvents:function(){var t=this;this._map.listens("moveend")||this._map.on("moveend",function(){t.migration.play(),t._draw()}),this._map.listens("zoomstart")||this._map.on("zoomstart ",function(){t.container.style.display="none"}),this._map.listens("zoomend")||this._map.on("zoomend",function(){t._show&&(t.container.style.display="",t._draw())})},_draw:function(){if(this._map.getBounds()&&this.migration.playAnimation){this._resize(),this._transform();var t=this._convertData();this.migration.updateData(t),this.migration.start(this.canvas)}},_transform:function(){var t=this._map.getBounds(),i=this._map.latLngToLayerPoint(t.getNorthWest());L.DomUtil.setPosition(this.container,i)},addTo:function(){this._bindMapEvents(),this._map.getPanes().overlayPane.appendChild(this.container);if(this._map.getBounds()&&this.migration.playAnimation){this._resize(),this._transform();var t=this._convertData();this.migration.updateData(t),this.migration.start(this.canvas)}},setData:function(t){this._data=t,this._draw()},hide:function(){this.container.style.display="none",this._show=!1},show:function(){this.container.style.display="",this._show=!0},play:function(){this.migration.play()},pause:function(){this.migration.pause()},destroy:function(){this.migration.clear(),this.container.parentNode.removeChild(this.container),this.mapHandles=[]}}),L.migrationLayer=function(t){return new L.MigrationLayer(t)}}(window);
